;; 1. Based on: run58
;; 2. Description: 58 final
$PROBLEM    rabbit PK
$INPUT      ID OLDID=DROP TIME TAD TIMED=DROP NGML DV AMT DOSE DOSEVOL EVID MDV II ADDL STUDY INFECTION 
			METAB WT BLQ CMTX REGION SAMPLEID TISSUEWT LOC CODOSE POOLED METHOD NDOSES SURFACEAREA BIOPSY L2
			STUDYSITE CHECKED=DROP
$DATA       ./BDQ_all_data_nm_v2.csv				 
						IGNORE=C
						IGNORE(CMTX.EQ.4)
						;IGNORE(METAB.EQ.1)
						;IGNORE(INFECTION.EQ.0)

$SUBROUTINE ADVAN6 TOL=5
$MODEL      NCOMP=5 COMP=(ABS,DEFDOSE) COMP=(CENTRAL) COMP=(PERIPH) COMP=(METAB) COMP=(TRANSIT1)
$PK
       
IF(L2.EQ.1) CMT = 2
IF(L2.EQ.2) CMT = 4

INFECTCOVCL = THETA(9)

CL = THETA(3)     
V  = THETA(4) * EXP(ETA(2))
KE = CL/V
KA = THETA(5)
S2 = V

DOSECOVF1 = THETA(8)

F1 = 1 * EXP(ETA(1))

Q = THETA(6)
V2 = THETA(7)

CLM = THETA(11)

VM = V

KM = CLM/VM

$DES      
DADT(1)=-KA*A(1)
DADT(2)= KA*A(5)-KE*A(2)-Q/V*A(2)+Q/V2*A(3)
DADT(3)= Q/V*A(2)-Q/V2*A(3)
DADT(4)= KE*A(2)-CLM*A(4)/VM
DADT(5)= KA*A(1)-KA*A(5)


$ERROR         

; Uppsala parent-metabolite error model
IPRED = 0 
IF(A(2).GT.0.AND.CMT.EQ.2) IPRED=A(2)/V
IF(A(4).GT.0.AND.CMT.EQ.4) IPRED=A(4)/VM

W = 1
IF(IPRED.GT.0.AND.CMT.EQ.2) W = THETA(1) ; residual error for parent only
IF(IPRED.GT.0.AND.CMT.EQ.4) W = THETA(2) ; residual error for metabolite only
W2 = THETA(10) ; common residual error to account for correlation

IRES=DV-IPRED
IWRES=IRES/W

IF(CMT.EQ.2) Y = IPRED+W*EPS(1) + W2*EPS(3) ;parent
IF(CMT.EQ.4) Y = IPRED+W*EPS(2) + W2*EPS(3) ;metabolite

$THETA
(0, 0.276) ; 1 Parent Error
(0, 0.0388) ; 2 Metabolite Error
(0, 11.2) ; 3 CL L/h
(0, 257) ; 4 V L
(0, 0.411) ; 5 KA 1/h
(0, 26) ; 6 Q
(0, 301) ;7 V2
(0) FIX ;8 DOSECOVF1
(1) FIX ; 9 INFECTCOVCL
(0) FIX ; 10 W2
(0, 27.2) ; 11 CLM

$OMEGA 
 0.101 ; IIV F1
 0.327 ; IIV V2

$SIGMA 
 1 FIX 
 1 FIX 
 1 FIX 

$ESTIMATION METHOD=1 INTERACTION PRINT=5 SIG=3 MAXEVAL=9999 NOABORT
$COVARIANCE UNCONDITIONAL 

$TABLE ID TIME TAD IPRED PRED DV AMT DOSE WRES IWRES CWRES EVID
NDOSES INFECTION WT METAB CL V KA KE F1 KM DOSECOVF1 INFECTCOVCL CMT FILE=sdtab59 NOPRINT ONEHEADER
$TABLE ID CL V KA KE FILE=patab59 NOPRINT ONEHEADER
